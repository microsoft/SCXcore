#!/bin/bash

scxpal_dir="../../pal"
scxomi_dir=`(cd ../../omi/distro; pwd -P)`
build_type="Release"
enable_debug=""
enable_purify_agent=""
enable_purify_server=""
enable_bullseye=""

omi_configure_quals="--prefix=/opt/microsoft/scx --localstatedir=/var/opt/microsoft/scx --sysconfdir=/etc/opt/microsoft/scx/conf --certsdir=/etc/opt/microsoft/scx/ssl --disable-libpath"

if [ ! -d "$scxpal_dir" ]; then
    echo "PAL directory ($scxpal_dir) does not exist"
    exit 1
fi

if [ ! -d "$scxomi_dir" ]; then
    echo "OMI directory ($scxomi_dir) does not exist"
    exit 1
fi

for opt
do

  arg=`expr "x$opt" : 'x[^=]*=\(.*\)'`

  case $opt in

    -h | --help)
      help=1
    ;;

    --enable-debug)
      if [ "$build_type" = "Bullseye" ]; then
          echo "Cannot build debug if Bullseye is enabled"
          exit 1
      fi
      build_type="Debug"
      enable_debug="--enable-debug"
    ;;

    --enable-bullseye)
      if [ "$build_type" = "Debug" ]; then
          echo "Cannot build Bullseye if debug is enabled"
          exit 1
      fi
      build_type="Bullseye"
      enable_bullseye="--enable-bullseye"
    ;;

    --enable-purify-agent)
      enable_purify_agent="--enable-purify-agent"
    ;;

    --enable-purify-server)
      enable_purify_server="--enable-purify-server"
    ;;

    --enable-local-omi)
      omi_configure_quals="--prefix=. --disable-libpath"
      local_omi="1"
    ;;

    *)
      echo "configure: invalid option '$opt'"
      echo "Try configure --help' for more information."
      exit 1
    ;;

  esac

done

if [ "$help" = "1" ]; then

    cat<<EOF

Usage: ./configure [OPTIONS]

OVERVIEW:

This script configures SCXOM for building. Type the following commands.

    $ ./configure
    $ make

OPTIONS:
    -h, --help                  Print this help message.
    --enable-debug              Perform a debug build.
    --enable-purify-agent       Allow agent to be run with purify (memory leak detection)
    --enable-purify-server      Allow server to be run with purify (memory leak detection)
    --enable-local-omi          Allow local OMI commands to be issued (not for use when building a kit)
    --enable-bullseye           Enables the use of code coverage tools (Bullseye).

EOF
    exit 0
fi

(cd $scxpal_dir/build/ && chmod ug+x ./configure; ./configure $enable_debug $enable_bullseye)

omi_configure_quals="--enable-dir-creation ${enable_debug} ${enable_purify_agent} ${enable_purify_server} ${omi_configure_quals}"

cat <<EOF > config.mak
LOCAL_OMI=$local_omi
OMI_CONFIGURE_QUALS="$omi_configure_quals"
EOF

# Fix permissions in case they aren't executable - and then configure OMI
chmod ug+x ${scxomi_dir}/configure ${scxomi_dir}/buildtool
(cd ${scxomi_dir} && ./configure ${omi_configure_quals})
