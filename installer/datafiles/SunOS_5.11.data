%Variables
PFMAJOR: '5'
PFMINOR: '11'

%OmiService_funcs
StopOmiServer() {
    svcadm disable -s svc:/application/management/omiserverd
    set +e
    COUNT=0
    while [ $COUNT -lt 15 ]; do
	echo "Waiting for service: svc:/application/management/omiserverd ..."
	sleep 1
	/usr/bin/svcs -H svc:/application/management/omiserverd 2> /dev/null | grep -i disabled > /dev/null 2>&1
	[ $? -eq 0 ] && return
	COUNT=`expr $COUNT + 1`
    done
}

StartOmiServer() {
    set +e
    svcadm restart svc:/system/manifest-import
    /usr/bin/svcs -H svc:/application/management/omiserverd 2> /dev/null | grep -i online > /dev/null 2>&1
    [ $? -eq 0 ] && return

    svcadm enable -s svc:/application/management/omiserverd
    COUNT=0
    while [ $COUNT -lt 15 ]; do
	echo "Waiting for service: svc:/application/management/omiserverd ..."
	sleep 1
	/usr/bin/svcs -H svc:/application/management/omiserverd 2> /dev/null | grep -i online > /dev/null 2>&1
	[ $? -eq 0 ] && break
	COUNT=`expr $COUNT + 1`
    done
}

%Preinstall_10
#include OmiService_funcs
#include CheckIfOmiIsRunning
if [ $OMI_IS_RUNNING -eq 1 ]; then
    StopOmiServer
fi

%Postinstall_1100
#include OmiService_funcs
set +e
StartOmiServer

%Preuninstall_9
#include OmiService_funcs
#include CheckIfOmiIsRunning
if [ $OMI_IS_RUNNING -eq 1 ]; then
    StopOmiServer
fi

%Postuninstall_200
set +e
#include OmiService_funcs
StartOmiServer
