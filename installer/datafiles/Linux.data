%Variables
PF:	      'Linux'
OMI_SERVICE:  '/opt/omi/bin/service_control'

%Files
/opt/microsoft/scx/bin/tools/GetLinuxOS.sh;                             target/${{BUILD_CONFIGURATION}}/GetLinuxOS.sh;                    755; root; root
/etc/opt/microsoft/scx/conf/scx-release;                                installer/conf/scx-release;                                       644; root; ${{ROOT_GROUP_NAME}}; conffile


%Postinstall_875
set -e

%Postinstall_1100
${{OMI_SERVICE}} reload

%Postinstall_1200
# Have we previously installed a Universal Kit before? Keep track of that!
# This is used by the OS provider to mimic non-universal kit installations ...
if ! egrep -q '^ORIGINAL_KIT_TYPE=' /etc/opt/microsoft/scx/conf/scxconfig.conf; then
    if [ -s /etc/opt/microsoft/scx/conf/scx-release ]; then
        echo 'ORIGINAL_KIT_TYPE=Universal' >> /etc/opt/microsoft/scx/conf/scxconfig.conf
    else
        echo 'ORIGINAL_KIT_TYPE=!Universal' >> /etc/opt/microsoft/scx/conf/scxconfig.conf
    fi
fi

# Generate the conf/scx-release file
/opt/microsoft/scx/bin/tools/GetLinuxOS.sh

%Postuninstall_50
#if DISABLE_PORT != true
    # If we're called for upgrade, don't do anything
    if ${{PERFORMING_UPGRADE_NOT}}; then
        # Remove port 1270 from the list of ports that OMI will listen on
        /opt/omi/bin/omiconfigeditor httpsport -r 1270 < /etc/opt/omi/conf/omiserver.conf > /etc/opt/omi/conf/omiserver.conf_temp
        mv /etc/opt/omi/conf/omiserver.conf_temp /etc/opt/omi/conf/omiserver.conf
    fi
#endif

%Postuninstall_1100
#include DeleteSoftLinkToSudo

${{OMI_SERVICE}} reload

# If we're called for upgrade, don't do anything
if ${{PERFORMING_UPGRADE_NOT}}; then
    DeleteSoftLinkToSudo
fi
