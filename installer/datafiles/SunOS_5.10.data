%Variables
SUDO_DIR: '/opt/sfw/bin'
PFMINOR: '10'
PFMAJOR: '5'

%OmiService_funcs
StopOmiServer() {
    svcadm disable -s svc:/application/management/omiserverd
}

StartOmiServer() {
    /usr/bin/svcs -H svc:/application/management/omiserverd 2> /dev/null | grep -i online > /dev/null 2>&1
    [ $? -eq 0 ] && return

    svcadm enable -s svc:/application/management/omiserverd
}

%Preinstall_10
#include OmiService_funcs
#include CheckIfOmiIsRunning
if [ $OMI_IS_RUNNING -eq 1 ]; then
    StopOmiServer
fi

%Postinstall_1050
# ConfigureOmiService
svccfg import /var/svc/manifest/application/management/omiserverd.xml

%Postinstall_1100
#include OmiService_funcs
set +e
StartOmiServer
COUNT=0
while [ $COUNT -lt 15 ]; do
    echo "Waiting for service: svc:/application/management/omiserverd ..."
    sleep 1
    /usr/bin/svcs -H svc:/application/management/omiserverd 2> /dev/null | grep -i online > /dev/null 2>&1
    [ $? -eq 0 ] && break
    COUNT=`expr $COUNT + 1`
done

%Preuninstall_9
#include OmiService_funcs
#include CheckIfOmiIsRunning
if [ $OMI_IS_RUNNING -eq 1 ]; then
    StopOmiServer
fi

%Postuninstall_1100
#include OmiService_funcs
StartOmiServer
